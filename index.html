<!doctype html>
<html lang="en" class="h-full">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="theme-color" content="#ffffff" />
  <title>Universal AI Chat Interface</title>

  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Marked (Markdown) -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

  <!-- highlight.js for code blocks -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/styles/github.min.css">
  <script src="https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/lib/highlight.min.js"></script>

  <style>
    #app { display: none; }
    .backdrop { background: rgba(0,0,0,.35); }
    .safe-b { padding-bottom: env(safe-area-inset-bottom); }
    pre, code { white-space: pre-wrap; word-break: break-word; }
    .caret::after { content: "‚ñç"; animation: blink 1s steps(1) infinite; margin-left: 2px; }
    @keyframes blink { 50% { opacity: 0; } }
  </style>

  <script>
    tailwind.config = { darkMode: 'class' }
  </script>
</head>

<body class="min-h-screen bg-zinc-50 text-zinc-900 dark:bg-zinc-950 dark:text-zinc-100">
  <!-- Fallback loader -->
  <div id="loading" class="min-h-screen flex items-center justify-center px-6">
    <div class="max-w-md w-full text-center">
      <div class="mx-auto h-10 w-10 rounded-full border-4 border-zinc-200 border-t-zinc-900 dark:border-zinc-800 dark:border-t-zinc-100 animate-spin"></div>
      <div class="mt-4 font-semibold">Loading App...</div>
      <div class="mt-1 text-sm text-zinc-500 dark:text-zinc-400">Preparing UI, storage, and safety checks</div>
      <noscript>
        <div class="mt-4 text-sm text-red-600">JavaScript is required to run this app.</div>
      </noscript>
    </div>
  </div>

  <div id="app" class="min-h-screen flex">
    <!-- Mobile overlay + sidebar -->
    <div id="mobileOverlay" class="fixed inset-0 hidden z-40">
      <div class="absolute inset-0 backdrop"></div>
    </div>

    <!-- Sidebar -->
    <aside id="sidebar"
      class="fixed z-50 inset-y-0 left-0 w-80 max-w-[85vw] transform -translate-x-full md:translate-x-0 md:static md:inset-auto md:z-auto
             bg-white dark:bg-zinc-900 border-r border-zinc-200 dark:border-zinc-800 flex flex-col">

      <div class="p-4 border-b border-zinc-200 dark:border-zinc-800 flex items-center justify-between gap-2">
        <div class="flex items-center gap-2">
          <div class="h-9 w-9 rounded-xl bg-zinc-900 dark:bg-zinc-100"></div>
          <div>
            <div class="font-semibold leading-tight">Universal Chat</div>
            <div class="text-xs text-zinc-500 dark:text-zinc-400">Gemini-style UI</div>
          </div>
        </div>
        <button id="closeSidebarBtn"
          class="md:hidden p-2 rounded-lg hover:bg-zinc-100 dark:hover:bg-zinc-800"
          aria-label="Close sidebar">‚úï</button>
      </div>

      <div class="p-3 flex gap-2">
        <button id="newChatBtn"
          class="flex-1 px-3 py-2 rounded-xl bg-zinc-900 text-white dark:bg-zinc-100 dark:text-zinc-900 hover:opacity-90 text-sm font-semibold">
          + New chat
        </button>
        <button id="settingsBtn"
          class="px-3 py-2 rounded-xl border border-zinc-200 dark:border-zinc-800 hover:bg-zinc-100 dark:hover:bg-zinc-800 text-sm">
          ‚öô
        </button>
        <button id="darkToggleBtn"
          class="px-3 py-2 rounded-xl border border-zinc-200 dark:border-zinc-800 hover:bg-zinc-100 dark:hover:bg-zinc-800 text-sm"
          title="Toggle dark mode">
          üåô
        </button>
      </div>

      <div class="px-3 pb-3">
        <input id="chatSearch"
          class="w-full px-3 py-2 rounded-xl border border-zinc-200 dark:border-zinc-800 bg-white dark:bg-zinc-950
                 focus:outline-none focus:ring-2 focus:ring-zinc-300 dark:focus:ring-zinc-700 text-sm"
          placeholder="Search chats..." />
      </div>

      <div id="chatList" class="flex-1 overflow-auto px-2 pb-2"></div>

      <div class="p-3 border-t border-zinc-200 dark:border-zinc-800 text-xs text-zinc-500 dark:text-zinc-400">
        Local-first ‚Ä¢ OpenRouter ‚Ä¢ Single-file
      </div>
    </aside>

    <!-- Main -->
    <main class="flex-1 flex flex-col min-h-screen">
      <header class="sticky top-0 z-30 bg-zinc-50/90 dark:bg-zinc-950/90 backdrop-blur border-b border-zinc-200 dark:border-zinc-800">
        <div class="px-3 md:px-6 py-3 flex items-center justify-between gap-3">
          <div class="flex items-center gap-2 min-w-0">
            <button id="hamburgerBtn"
              class="md:hidden p-2 rounded-lg hover:bg-zinc-100 dark:hover:bg-zinc-800"
              aria-label="Open sidebar">‚ò∞</button>
            <div class="min-w-0">
              <div id="chatTitle" class="font-semibold truncate">New chat</div>
              <div id="chatMeta" class="text-xs text-zinc-500 dark:text-zinc-400 truncate">
                Model: <span id="modelLabel">deepseek/deepseek-r1:free</span>
              </div>
            </div>
          </div>

          <div class="flex items-center gap-2">
            <button id="systemPromptBtn"
              class="px-3 py-2 rounded-xl border border-zinc-200 dark:border-zinc-800 hover:bg-zinc-100 dark:hover:bg-zinc-800 text-sm">
              üß† System
            </button>
            <button id="clearBtn"
              class="px-3 py-2 rounded-xl border border-zinc-200 dark:border-zinc-800 hover:bg-zinc-100 dark:hover:bg-zinc-800 text-sm">
              üßπ Clear
            </button>
          </div>
        </div>
      </header>

      <section class="flex-1 min-h-0">
        <div id="messages" class="h-full overflow-auto px-3 md:px-6 py-6 space-y-4">
          <div id="emptyState" class="py-16 text-center text-zinc-500 dark:text-zinc-400">
            <div class="text-xl font-semibold text-zinc-800 dark:text-zinc-200">Start a conversation</div>
            <div class="mt-2 text-sm">Your chats are saved locally. Add your OpenRouter key in Settings.</div>
          </div>
        </div>
      </section>

      <!-- Input bar -->
      <footer class="sticky bottom-0 z-30 safe-b bg-zinc-50/95 dark:bg-zinc-950/95 backdrop-blur border-t border-zinc-200 dark:border-zinc-800">
        <div class="px-3 md:px-6 py-3">
          <div class="flex items-end gap-2">
            <!-- Voice / TTS controls -->
            <div class="flex flex-col gap-2">
              <button id="micBtn"
                class="p-3 rounded-2xl border border-zinc-200 dark:border-zinc-800 hover:bg-zinc-100 dark:hover:bg-zinc-800"
                title="Voice input (Speech-to-Text)">
                üéô
              </button>
              <button id="ttsToggleBtn"
                class="p-3 rounded-2xl border border-zinc-200 dark:border-zinc-800 hover:bg-zinc-100 dark:hover:bg-zinc-800"
                title="Toggle AI voice (Text-to-Speech)">
                üîä
              </button>
            </div>

            <div class="flex-1">
              <div class="relative">
                <textarea id="promptInput" rows="1"
                  class="w-full resize-none px-4 py-3 pr-16 rounded-2xl border border-zinc-200 dark:border-zinc-800
                         bg-white dark:bg-zinc-900 focus:outline-none focus:ring-2 focus:ring-zinc-300 dark:focus:ring-zinc-700
                         text-sm leading-5 max-h-40 overflow-auto"
                  placeholder="Message..." ></textarea>
                <button id="stopBtn"
                  class="hidden absolute right-2 bottom-2 px-3 py-1.5 rounded-xl text-xs font-semibold
                         bg-red-600 text-white hover:opacity-90">
                  Stop
                </button>
              </div>
              <div id="hintBar" class="mt-2 text-xs text-zinc-500 dark:text-zinc-400 flex flex-wrap gap-x-3 gap-y-1">
                <span>Enter = send ‚Ä¢ Shift+Enter = newline</span>
                <span id="voiceHint">Mic: ready</span>
                <span id="ttsHint">TTS: off</span>
              </div>
            </div>

            <button id="sendBtn"
              class="shrink-0 px-4 py-3 rounded-2xl bg-zinc-900 text-white dark:bg-zinc-100 dark:text-zinc-900 font-semibold text-sm hover:opacity-90">
              Send
            </button>
          </div>

          <div id="statusBar" class="mt-2 text-xs text-zinc-500 dark:text-zinc-400"></div>
        </div>
      </footer>
    </main>
  </div>

  <!-- Settings Modal -->
  <div id="settingsModal" class="fixed inset-0 z-[60] hidden">
    <div class="absolute inset-0 backdrop"></div>
    <div class="absolute inset-0 flex items-center justify-center p-4">
      <div class="w-full max-w-lg rounded-2xl bg-white dark:bg-zinc-900 border border-zinc-200 dark:border-zinc-800 shadow-xl">
        <div class="p-4 border-b border-zinc-200 dark:border-zinc-800 flex items-center justify-between">
          <div class="font-semibold">Settings</div>
          <button class="p-2 rounded-lg hover:bg-zinc-100 dark:hover:bg-zinc-800" data-close="settingsModal">‚úï</button>
        </div>
        <div class="p-4 space-y-4">
          <div>
            <label class="text-sm font-semibold">OpenRouter API Key</label>
            <input id="apiKeyInput" type="password" autocomplete="off"
              class="mt-1 w-full px-3 py-2 rounded-xl border border-zinc-200 dark:border-zinc-800 bg-white dark:bg-zinc-950
                     focus:outline-none focus:ring-2 focus:ring-zinc-300 dark:focus:ring-zinc-700 text-sm"
              placeholder="sk-or-..." />
            <div class="mt-1 text-xs text-zinc-500 dark:text-zinc-400">
              Stored only in your browser (localStorage).
            </div>
          </div>

          <div>
            <label class="text-sm font-semibold">Model</label>
            <input id="modelInput" type="text"
              class="mt-1 w-full px-3 py-2 rounded-xl border border-zinc-200 dark:border-zinc-800 bg-white dark:bg-zinc-950
                     focus:outline-none focus:ring-2 focus:ring-zinc-300 dark:focus:ring-zinc-700 text-sm"
              placeholder="deepseek/deepseek-r1:free" />
          </div>

          <div class="border-t border-zinc-200 dark:border-zinc-800 pt-4">
            <div class="font-semibold text-sm">Audio</div>
            <div class="mt-3 space-y-3">
              <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                <div>
                  <label class="text-sm font-semibold">Voice language (STT/TTS)</label>
                  <select id="voiceLangSelect"
                    class="mt-1 w-full px-3 py-2 rounded-xl border border-zinc-200 dark:border-zinc-800 bg-white dark:bg-zinc-950
                           focus:outline-none focus:ring-2 focus:ring-zinc-300 dark:focus:ring-zinc-700 text-sm">
                    <option value="bn-BD">‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ (bn-BD)</option>
                    <option value="bn-IN">‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ (bn-IN)</option>
                    <option value="en-US">English (en-US)</option>
                    <option value="en-GB">English (en-GB)</option>
                    <option value="hi-IN">Hindi (hi-IN)</option>
                  </select>
                </div>
                <div class="flex items-end">
                  <label class="flex items-center gap-2 text-sm">
                    <input id="autoSendVoiceChk" type="checkbox" class="h-4 w-4">
                    Auto-send after dictation
                  </label>
                </div>
              </div>

              <label class="flex items-center gap-2 text-sm">
                <input id="autoSpeakAiChk" type="checkbox" class="h-4 w-4">
                Auto-speak AI responses (TTS)
              </label>

              <div class="text-xs text-zinc-500 dark:text-zinc-400">
                Browser voice uses Web Speech API (no keys). Note: SpeechRecognition support varies across browsers. :contentReference[oaicite:7]{index=7}
              </div>
            </div>
          </div>

          <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
            <button id="saveSettingsBtn"
              class="px-3 py-2 rounded-xl bg-zinc-900 text-white dark:bg-zinc-100 dark:text-zinc-900 font-semibold hover:opacity-90">
              Save
            </button>
            <button class="px-3 py-2 rounded-xl border border-zinc-200 dark:border-zinc-800 hover:bg-zinc-100 dark:hover:bg-zinc-800"
              data-close="settingsModal">
              Cancel
            </button>
          </div>

          <div class="pt-2 border-t border-zinc-200 dark:border-zinc-800">
            <div class="text-sm font-semibold">Advanced Agent Mode</div>
            <div class="mt-1 text-xs text-zinc-500 dark:text-zinc-400">
              Use System Prompt to define agent behaviors (planning, checklists, structured output).
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- System Prompt Modal -->
  <div id="systemModal" class="fixed inset-0 z-[60] hidden">
    <div class="absolute inset-0 backdrop"></div>
    <div class="absolute inset-0 flex items-center justify-center p-4">
      <div class="w-full max-w-2xl rounded-2xl bg-white dark:bg-zinc-900 border border-zinc-200 dark:border-zinc-800 shadow-xl">
        <div class="p-4 border-b border-zinc-200 dark:border-zinc-800 flex items-center justify-between">
          <div class="font-semibold">System Prompt</div>
          <button class="p-2 rounded-lg hover:bg-zinc-100 dark:hover:bg-zinc-800" data-close="systemModal">‚úï</button>
        </div>

        <div class="p-4 space-y-3">
          <div class="flex items-center justify-between gap-2">
            <div class="text-sm text-zinc-600 dark:text-zinc-300">Choose scope:</div>
            <div class="flex gap-2">
              <button id="sysScopeChatBtn"
                class="px-3 py-1.5 rounded-xl border border-zinc-200 dark:border-zinc-800 hover:bg-zinc-100 dark:hover:bg-zinc-800 text-sm">
                Per Chat
              </button>
              <button id="sysScopeGlobalBtn"
                class="px-3 py-1.5 rounded-xl border border-zinc-200 dark:border-zinc-800 hover:bg-zinc-100 dark:hover:bg-zinc-800 text-sm">
                Global
              </button>
            </div>
          </div>

          <textarea id="systemPromptArea" rows="10"
            class="w-full px-3 py-3 rounded-xl border border-zinc-200 dark:border-zinc-800 bg-white dark:bg-zinc-950
                   focus:outline-none focus:ring-2 focus:ring-zinc-300 dark:focus:ring-zinc-700 text-sm"
            placeholder="You are an advanced agent..."></textarea>

          <div class="grid grid-cols-1 md:grid-cols-2 gap-3 pt-1">
            <button id="saveSystemBtn"
              class="px-3 py-2 rounded-xl bg-zinc-900 text-white dark:bg-zinc-100 dark:text-zinc-900 font-semibold hover:opacity-90">
              Save
            </button>
            <button class="px-3 py-2 rounded-xl border border-zinc-200 dark:border-zinc-800 hover:bg-zinc-100 dark:hover:bg-zinc-800"
              data-close="systemModal">
              Close
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Rename Modal -->
  <div id="renameModal" class="fixed inset-0 z-[60] hidden">
    <div class="absolute inset-0 backdrop"></div>
    <div class="absolute inset-0 flex items-center justify-center p-4">
      <div class="w-full max-w-md rounded-2xl bg-white dark:bg-zinc-900 border border-zinc-200 dark:border-zinc-800 shadow-xl">
        <div class="p-4 border-b border-zinc-200 dark:border-zinc-800 flex items-center justify-between">
          <div class="font-semibold">Rename chat</div>
          <button class="p-2 rounded-lg hover:bg-zinc-100 dark:hover:bg-zinc-800" data-close="renameModal">‚úï</button>
        </div>
        <div class="p-4 space-y-3">
          <input id="renameInput" type="text"
            class="w-full px-3 py-2 rounded-xl border border-zinc-200 dark:border-zinc-800 bg-white dark:bg-zinc-950
                   focus:outline-none focus:ring-2 focus:ring-zinc-300 dark:focus:ring-zinc-700 text-sm"
            placeholder="Chat title" />
          <div class="grid grid-cols-2 gap-3">
            <button id="renameSaveBtn"
              class="px-3 py-2 rounded-xl bg-zinc-900 text-white dark:bg-zinc-100 dark:text-zinc-900 font-semibold hover:opacity-90">
              Save
            </button>
            <button class="px-3 py-2 rounded-xl border border-zinc-200 dark:border-zinc-800 hover:bg-zinc-100 dark:hover:bg-zinc-800"
              data-close="renameModal">
              Cancel
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- IMPORTANT: Script ONLY at end of body -->
  <script>
    (function () {
      "use strict";

      const $ = (id) => document.getElementById(id);
      const safeText = (v, fallback = "") => (typeof v === "string" ? v : (v == null ? fallback : String(v)));
      const nowISO = () => new Date().toISOString();
      const uid = () => Math.random().toString(16).slice(2) + Math.random().toString(16).slice(2);

      const KEYS = Object.freeze({
        apiKey: "uai.openrouter.key",
        model: "uai.openrouter.model",
        dark: "uai.ui.dark",
        chats: "uai.chats",
        active: "uai.activeChat",
        globalSystem: "uai.system.global",
        voiceLang: "uai.audio.lang",
        autoSendVoice: "uai.audio.autosend",
        autoSpeakAi: "uai.audio.autospeak"
      });

      const DEFAULT_MODEL = "deepseek/deepseek-r1:free";
      const OPENROUTER_URL = "https://openrouter.ai/api/v1/chat/completions";

      const state = {
        apiKey: "",
        model: DEFAULT_MODEL,
        dark: false,
        chats: [],
        activeChatId: null,
        streaming: false,
        abortController: null,
        sysScope: "chat",
        renameTargetId: null,

        // Audio
        voiceLang: "bn-BD",
        autoSendVoice: false,
        autoSpeakAi: false,
        listening: false,
        recognition: null
      };

      // Markdown config
      try {
        marked.setOptions({
          gfm: true,
          breaks: true,
          mangle: false,
          headerIds: false,
          highlight: function (code, lang) {
            try {
              if (lang && hljs.getLanguage(lang)) return hljs.highlight(code, { language: lang }).value;
              return hljs.highlightAuto(code).value;
            } catch (_) { return code; }
          }
        });
      } catch (_) {}

      function loadLS(key, fallback) {
        try { const v = localStorage.getItem(key); return v == null ? fallback : v; }
        catch (_) { return fallback; }
      }
      function saveLS(key, value) {
        try { localStorage.setItem(key, value); } catch (_) {}
      }
      function loadJSON(key, fallback) {
        try { const v = localStorage.getItem(key); if (!v) return fallback; return JSON.parse(v); }
        catch (_) { return fallback; }
      }
      function saveJSON(key, obj) {
        try { localStorage.setItem(key, JSON.stringify(obj)); } catch (_) {}
      }

      // UI refs
      const el = {
        loading: $("loading"),
        app: $("app"),
        sidebar: $("sidebar"),
        mobileOverlay: $("mobileOverlay"),
        chatList: $("chatList"),
        chatTitle: $("chatTitle"),
        modelLabel: $("modelLabel"),
        messages: $("messages"),
        emptyState: $("emptyState"),
        promptInput: $("promptInput"),
        sendBtn: $("sendBtn"),
        stopBtn: $("stopBtn"),
        statusBar: $("statusBar"),
        hintBar: $("hintBar"),
        voiceHint: $("voiceHint"),
        ttsHint: $("ttsHint"),

        hamburgerBtn: $("hamburgerBtn"),
        closeSidebarBtn: $("closeSidebarBtn"),
        newChatBtn: $("newChatBtn"),
        settingsBtn: $("settingsBtn"),
        darkToggleBtn: $("darkToggleBtn"),
        systemPromptBtn: $("systemPromptBtn"),
        clearBtn: $("clearBtn"),
        chatSearch: $("chatSearch"),

        // audio buttons
        micBtn: $("micBtn"),
        ttsToggleBtn: $("ttsToggleBtn"),

        // modals
        settingsModal: $("settingsModal"),
        apiKeyInput: $("apiKeyInput"),
        modelInput: $("modelInput"),
        saveSettingsBtn: $("saveSettingsBtn"),

        // audio settings
        voiceLangSelect: $("voiceLangSelect"),
        autoSendVoiceChk: $("autoSendVoiceChk"),
        autoSpeakAiChk: $("autoSpeakAiChk"),

        systemModal: $("systemModal"),
        systemPromptArea: $("systemPromptArea"),
        saveSystemBtn: $("saveSystemBtn"),
        sysScopeChatBtn: $("sysScopeChatBtn"),
        sysScopeGlobalBtn: $("sysScopeGlobalBtn"),

        renameModal: $("renameModal"),
        renameInput: $("renameInput"),
        renameSaveBtn: $("renameSaveBtn"),
      };

      // Theme
      function applyDarkMode(isDark) {
        state.dark = !!isDark;
        document.documentElement.classList.toggle("dark", state.dark);
        saveLS(KEYS.dark, state.dark ? "1" : "0");
        const meta = document.querySelector('meta[name="theme-color"]');
        if (meta) meta.setAttribute("content", state.dark ? "#09090b" : "#ffffff");
      }

      // Sidebar mobile
      function openSidebar() {
        el.sidebar.classList.remove("-translate-x-full");
        el.mobileOverlay.classList.remove("hidden");
      }
      function closeSidebar() {
        if (window.matchMedia("(min-width: 768px)").matches) return;
        el.sidebar.classList.add("-translate-x-full");
        el.mobileOverlay.classList.add("hidden");
      }

      // Modal helpers
      function openModal(modalEl) { if (modalEl) modalEl.classList.remove("hidden"); }
      function closeModal(modalEl) { if (modalEl) modalEl.classList.add("hidden"); }

      document.addEventListener("click", (e) => {
        const t = e.target;
        if (!(t instanceof Element)) return;
        const key = t.getAttribute("data-close");
        if (key && $(key)) closeModal($(key));
      });

      document.addEventListener("keydown", (e) => {
        if (e.key !== "Escape") return;
        closeSidebar();
        closeModal(el.settingsModal);
        closeModal(el.systemModal);
        closeModal(el.renameModal);
        stopListening();
        stopSpeaking();
      });

      function setStatus(msg, kind) {
        const t = safeText(msg, "");
        el.statusBar.textContent = t;
        el.statusBar.className = "mt-2 text-xs " + (kind === "error"
          ? "text-red-600 dark:text-red-400"
          : "text-zinc-500 dark:text-zinc-400");
      }

      // Chat model
      function createChat(initialTitle = "New chat") {
        const id = uid();
        const t = safeText(initialTitle, "New chat").trim() || "New chat";
        return { id, title: t, createdAt: nowISO(), updatedAt: nowISO(), messages: [], systemPrompt: "" };
      }
      function getActiveChat() { return state.chats.find(c => c.id === state.activeChatId) || null; }
      function touchChat(chat) { if (chat) chat.updatedAt = nowISO(); }
      function persistChats() { saveJSON(KEYS.chats, state.chats); if (state.activeChatId) saveLS(KEYS.active, state.activeChatId); }

      function ensureActiveChat() {
        if (state.activeChatId && getActiveChat()) return getActiveChat();
        if (state.chats.length) {
          const sorted = [...state.chats].sort((a, b) => (b.updatedAt || "").localeCompare(a.updatedAt || ""));
          state.activeChatId = sorted[0].id;
          saveLS(KEYS.active, state.activeChatId);
          return getActiveChat();
        }
        const c = createChat("New chat");
        state.chats.push(c);
        state.activeChatId = c.id;
        persistChats();
        return c;
      }

      function formatWhen(iso) {
        try {
          const d = new Date(iso);
          const now = new Date();
          const sameDay = d.toDateString() === now.toDateString();
          if (sameDay) return d.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
          return d.toLocaleDateString([], { month: 'short', day: '2-digit' });
        } catch (_) { return ""; }
      }

      function renderChatList() {
        const q = safeText(el.chatSearch?.value, "").trim().toLowerCase();
        const chats = [...state.chats].sort((a, b) => (b.updatedAt || "").localeCompare(a.updatedAt || ""));
        const filtered = q ? chats.filter(c => safeText(c.title).toLowerCase().includes(q)) : chats;

        el.chatList.innerHTML = "";
        if (!filtered.length) {
          const empty = document.createElement("div");
          empty.className = "p-4 text-sm text-zinc-500 dark:text-zinc-400";
          empty.textContent = q ? "No chats match your search." : "No chats yet. Click ‚ÄúNew chat‚Äù.";
          el.chatList.appendChild(empty);
          return;
        }

        filtered.forEach(chat => {
          const isActive = chat.id === state.activeChatId;

          const row = document.createElement("div");
          row.className =
            "group px-2 py-2 rounded-xl cursor-pointer flex items-center gap-2 " +
            (isActive ? "bg-zinc-100 dark:bg-zinc-800" : "hover:bg-zinc-100 dark:hover:bg-zinc-800");

          const left = document.createElement("div");
          left.className = "min-w-0 flex-1";

          const title = document.createElement("div");
          title.className = "text-sm font-semibold truncate";
          title.textContent = safeText(chat.title, "Untitled");

          const meta = document.createElement("div");
          meta.className = "text-xs text-zinc-500 dark:text-zinc-400 flex items-center justify-between gap-2";
          const count = (chat.messages && chat.messages.length) ? chat.messages.length : 0;
          meta.innerHTML = `<span>${count} msgs</span><span>${formatWhen(chat.updatedAt || chat.createdAt)}</span>`;

          left.appendChild(title);
          left.appendChild(meta);

          const actions = document.createElement("div");
          actions.className = "flex gap-1 opacity-100 md:opacity-0 md:group-hover:opacity-100 transition";

          const renameBtn = document.createElement("button");
          renameBtn.className = "p-2 rounded-lg hover:bg-white dark:hover:bg-zinc-900";
          renameBtn.title = "Rename";
          renameBtn.textContent = "‚úé";

          const delBtn = document.createElement("button");
          delBtn.className = "p-2 rounded-lg hover:bg-white dark:hover:bg-zinc-900";
          delBtn.title = "Delete";
          delBtn.textContent = "üóë";

          renameBtn.addEventListener("click", (e) => {
            e.stopPropagation();
            state.renameTargetId = chat.id;
            el.renameInput.value = safeText(chat.title, "");
            openModal(el.renameModal);
            setTimeout(() => el.renameInput?.focus(), 0);
          });

          delBtn.addEventListener("click", (e) => {
            e.stopPropagation();
            const ok = confirm(`Delete chat "${safeText(chat.title, "Chat")}"?`);
            if (!ok) return;
            state.chats = state.chats.filter(c => c.id !== chat.id);
            if (state.activeChatId === chat.id) {
              state.activeChatId = null;
              saveLS(KEYS.active, "");
              ensureActiveChat();
            }
            persistChats();
            renderChatList();
            updateHeader();
            renderMessages();
          });

          actions.appendChild(renameBtn);
          actions.appendChild(delBtn);

          row.appendChild(left);
          row.appendChild(actions);

          row.addEventListener("click", () => {
            setActiveChat(chat.id);
            closeSidebar();
          });

          el.chatList.appendChild(row);
        });
      }

      function sanitizeHTML(html) {
        return safeText(html, "").replace(/<script[\s\S]*?>[\s\S]*?<\/script>/gi, "");
      }
      function renderMarkdown(content) {
        try { return sanitizeHTML(marked.parse(safeText(content, ""))); }
        catch (_) { return `<p>${safeText(content, "").replace(/</g, "&lt;")}</p>`; }
      }
      function scrollToBottom() {
        try { el.messages.scrollTop = el.messages.scrollHeight; } catch (_) {}
      }

      // --- TTS helpers ---
      function stripForSpeech(markdownText) {
        const t = safeText(markdownText, "");
        // cheap-ish cleanup
        return t
          .replace(/```[\s\S]*?```/g, " ")   // remove code blocks
          .replace(/`([^`]+)`/g, "$1")       // inline code
          .replace(/\[([^\]]+)\]\(([^)]+)\)/g, "$1")
          .replace(/[#>*_~]/g, " ")
          .replace(/\s+/g, " ")
          .trim();
      }

      function setTtsHint() {
        el.ttsHint.textContent = "TTS: " + (state.autoSpeakAi ? "on" : "off");
        el.ttsToggleBtn.classList.toggle("bg-zinc-900", state.autoSpeakAi && !state.dark);
        el.ttsToggleBtn.classList.toggle("text-white", state.autoSpeakAi && !state.dark);
        el.ttsToggleBtn.classList.toggle("dark:bg-zinc-100", state.autoSpeakAi);
        el.ttsToggleBtn.classList.toggle("dark:text-zinc-900", state.autoSpeakAi);
      }

      function stopSpeaking() {
        try { if ("speechSynthesis" in window) window.speechSynthesis.cancel(); } catch (_) {}
      }

      function speakText(text) {
        if (!("speechSynthesis" in window)) {
          setStatus("TTS not supported in this browser.", "error");
          return;
        }
        const clean = stripForSpeech(text);
        if (!clean) return;

        stopSpeaking();
        const u = new SpeechSynthesisUtterance(clean);
        u.lang = state.voiceLang || "bn-BD";

        // try to pick best voice for lang
        try {
          const voices = window.speechSynthesis.getVoices?.() || [];
          const v = voices.find(v => (v.lang || "").toLowerCase() === (u.lang || "").toLowerCase())
                || voices.find(v => (v.lang || "").toLowerCase().startsWith((u.lang || "").slice(0,2).toLowerCase()));
          if (v) u.voice = v;
        } catch (_) {}

        window.speechSynthesis.speak(u);
      }

      // --- STT (SpeechRecognition) ---
      function isSpeechRecognitionSupported() {
        return !!(window.SpeechRecognition || window.webkitSpeechRecognition);
      }

      function setVoiceHint() {
        if (!isSpeechRecognitionSupported()) {
          el.voiceHint.textContent = "Mic: unsupported";
          return;
        }
        el.voiceHint.textContent = "Mic: " + (state.listening ? "listening..." : "ready");
      }

      function initSpeechRecognition() {
        if (!isSpeechRecognitionSupported()) return null;
        const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
        const rec = new SR();
        rec.lang = state.voiceLang || "bn-BD";
        rec.interimResults = true;
        rec.continuous = false;

        let finalTranscript = "";

        rec.onstart = () => {
          state.listening = true;
          setVoiceHint();
          setStatus("Listening... speak now.", "info");
          el.micBtn.classList.add("bg-zinc-900", "text-white");
          el.micBtn.classList.add("dark:bg-zinc-100", "dark:text-zinc-900");
        };

        rec.onerror = (e) => {
          state.listening = false;
          setVoiceHint();
          el.micBtn.classList.remove("bg-zinc-900", "text-white", "dark:bg-zinc-100", "dark:text-zinc-900");
          setStatus("Mic error: " + safeText(e?.error, "unknown"), "error");
        };

        rec.onend = () => {
          state.listening = false;
          setVoiceHint();
          el.micBtn.classList.remove("bg-zinc-900", "text-white", "dark:bg-zinc-100", "dark:text-zinc-900");

          // Append final transcript
          finalTranscript = finalTranscript.trim();
          if (finalTranscript) {
            const current = safeText(el.promptInput.value, "");
            el.promptInput.value = (current ? (current + " ") : "") + finalTranscript;
            autosizeTextarea();
            if (state.autoSendVoice) {
              sendMessage();
            } else {
              setStatus("Voice captured. Edit if needed, then Send.", "info");
            }
          }
        };

        rec.onresult = (event) => {
          let interim = "";
          finalTranscript = "";

          for (let i = event.resultIndex; i < event.results.length; i++) {
            const res = event.results[i];
            const txt = safeText(res?.[0]?.transcript, "");
            if (res.isFinal) finalTranscript += txt + " ";
            else interim += txt + " ";
          }

          // show interim in status
          const preview = (finalTranscript + interim).trim();
          if (preview) setStatus("Listening: " + preview, "info");
        };

        return rec;
      }

      function startListening() {
        if (!isSpeechRecognitionSupported()) {
          setStatus("SpeechRecognition not supported. Use Chrome / Android Chrome.", "error");
          return;
        }
        if (!state.recognition) state.recognition = initSpeechRecognition();
        if (!state.recognition) return;
        try {
          state.recognition.lang = state.voiceLang || "bn-BD";
          state.recognition.start();
        } catch (e) {
          // Some browsers throw if start called twice
          setStatus("Mic busy. Try again.", "error");
        }
      }

      function stopListening() {
        try { state.recognition?.stop?.(); } catch (_) {}
        state.listening = false;
        setVoiceHint();
      }

      // Messages rendering with speak button for AI
      function renderMessages() {
        const chat = getActiveChat();
        el.messages.innerHTML = "";

        const msgs = (chat && Array.isArray(chat.messages)) ? chat.messages : [];
        if (!msgs.length) {
          el.messages.appendChild(el.emptyState);
          return;
        }

        msgs.forEach((m) => {
          const role = safeText(m.role, "assistant");
          const isUser = role === "user";

          const wrap = document.createElement("div");
          wrap.className = "w-full flex " + (isUser ? "justify-end" : "justify-start");

          const bubble = document.createElement("div");
          bubble.className =
            "max-w-[92%] md:max-w-[75%] rounded-2xl px-4 py-3 border text-sm leading-6 " +
            (isUser
              ? "bg-zinc-900 text-white border-zinc-900 dark:bg-zinc-100 dark:text-zinc-900 dark:border-zinc-100"
              : "bg-white dark:bg-zinc-900 border-zinc-200 dark:border-zinc-800");

          // bubble header actions for assistant
          if (!isUser) {
            const actions = document.createElement("div");
            actions.className = "mb-2 flex items-center justify-end gap-2";

            const speakBtn = document.createElement("button");
            speakBtn.className = "px-2 py-1 rounded-lg border border-zinc-200 dark:border-zinc-800 hover:bg-zinc-100 dark:hover:bg-zinc-800 text-xs";
            speakBtn.textContent = "Speak";

            const stopBtn = document.createElement("button");
            stopBtn.className = "px-2 py-1 rounded-lg border border-zinc-200 dark:border-zinc-800 hover:bg-zinc-100 dark:hover:bg-zinc-800 text-xs";
            stopBtn.textContent = "Stop";

            const copyBtn = document.createElement("button");
            copyBtn.className = "px-2 py-1 rounded-lg border border-zinc-200 dark:border-zinc-800 hover:bg-zinc-100 dark:hover:bg-zinc-800 text-xs";
            copyBtn.textContent = "Copy";

            speakBtn.addEventListener("click", () => speakText(safeText(m.content, "")));
            stopBtn.addEventListener("click", () => stopSpeaking());
            copyBtn.addEventListener("click", async () => {
              try {
                await navigator.clipboard.writeText(safeText(m.content, ""));
                setStatus("Copied.", "info");
              } catch (_) {
                setStatus("Copy failed.", "error");
              }
            });

            actions.appendChild(copyBtn);
            actions.appendChild(speakBtn);
            actions.appendChild(stopBtn);
            bubble.appendChild(actions);
          }

          const content = document.createElement("div");
          content.className = "prose prose-zinc dark:prose-invert max-w-none prose-pre:rounded-xl prose-pre:border prose-pre:border-zinc-200 dark:prose-pre:border-zinc-800";
          content.innerHTML = renderMarkdown(safeText(m.content, ""));

          bubble.appendChild(content);
          wrap.appendChild(bubble);
          el.messages.appendChild(wrap);

          try { bubble.querySelectorAll("pre code").forEach((block) => hljs.highlightElement(block)); } catch (_) {}
        });

        scrollToBottom();
      }

      function setChatTitleFromContent(chat) {
        if (!chat) return;
        if (chat.title && chat.title !== "New chat") return;
        const firstUser = (chat.messages || []).find(m => m.role === "user" && safeText(m.content).trim());
        if (!firstUser) return;
        const t = safeText(firstUser.content).trim().slice(0, 48);
        chat.title = t || "New chat";
      }

      function updateHeader() {
        const chat = getActiveChat();
        el.chatTitle.textContent = chat ? safeText(chat.title, "Chat") : "New chat";
        el.modelLabel.textContent = safeText(state.model, DEFAULT_MODEL);
      }

      function setActiveChat(id) {
        const exists = state.chats.some(c => c.id === id);
        if (!exists) return;
        state.activeChatId = id;
        saveLS(KEYS.active, id);
        updateHeader();
        renderChatList();
        renderMessages();
      }

      function newChat() {
        const c = createChat("New chat");
        state.chats.unshift(c);
        state.activeChatId = c.id;
        persistChats();
        renderChatList();
        updateHeader();
        renderMessages();
        closeSidebar();
        setTimeout(() => el.promptInput?.focus(), 0);
      }

      function clearActiveChatMessages() {
        const chat = getActiveChat();
        if (!chat) return;
        const ok = confirm("Clear all messages in this chat?");
        if (!ok) return;
        chat.messages = [];
        touchChat(chat);
        persistChats();
        renderMessages();
        renderChatList();
      }

      // System prompt
      function getGlobalSystemPrompt() { return safeText(loadLS(KEYS.globalSystem, ""), ""); }
      function setGlobalSystemPrompt(v) { saveLS(KEYS.globalSystem, safeText(v, "")); }
      function getEffectiveSystemPrompt(chat) {
        const perChat = safeText(chat?.systemPrompt, "").trim();
        const global = safeText(getGlobalSystemPrompt(), "").trim();
        return perChat || global || "";
      }

      function highlightSysScopeButtons() {
        const on = "bg-zinc-900 text-white dark:bg-zinc-100 dark:text-zinc-900";
        const off = "border border-zinc-200 dark:border-zinc-800 hover:bg-zinc-100 dark:hover:bg-zinc-800";
        if (state.sysScope === "chat") {
          el.sysScopeChatBtn.className = "px-3 py-1.5 rounded-xl text-sm " + on;
          el.sysScopeGlobalBtn.className = "px-3 py-1.5 rounded-xl text-sm " + off;
        } else {
          el.sysScopeGlobalBtn.className = "px-3 py-1.5 rounded-xl text-sm " + on;
          el.sysScopeChatBtn.className = "px-3 py-1.5 rounded-xl text-sm " + off;
        }
      }

      function openSystemModal() {
        const chat = ensureActiveChat();
        state.sysScope = "chat";
        highlightSysScopeButtons();
        el.systemPromptArea.value = safeText(chat.systemPrompt, "");
        openModal(el.systemModal);
        setTimeout(() => el.systemPromptArea?.focus(), 0);
      }

      function loadSystemPromptIntoModal(scope) {
        const chat = ensureActiveChat();
        if (scope === "global") el.systemPromptArea.value = safeText(getGlobalSystemPrompt(), "");
        else el.systemPromptArea.value = safeText(chat.systemPrompt, "");
      }

      function saveSystemPromptFromModal() {
        const v = safeText(el.systemPromptArea.value, "");
        const chat = ensureActiveChat();
        if (state.sysScope === "global") setGlobalSystemPrompt(v);
        else { chat.systemPrompt = v; touchChat(chat); persistChats(); }
        closeModal(el.systemModal);
      }

      // Input UX
      function autosizeTextarea() {
        const ta = el.promptInput;
        if (!ta) return;
        ta.style.height = "auto";
        const h = Math.min(160, ta.scrollHeight);
        ta.style.height = h + "px";
      }

      // Messages payload for OpenRouter
      function buildRequestMessages(chat) {
        const arr = [];
        const sys = getEffectiveSystemPrompt(chat);
        if (sys) arr.push({ role: "system", content: sys });
        (chat.messages || []).forEach(m => {
          const r = safeText(m.role, "");
          if (r !== "user" && r !== "assistant") return;
          arr.push({ role: r, content: safeText(m.content, "") });
        });
        return arr;
      }

      function addMessage(chat, role, content) {
        if (!chat) return null;
        const msg = { role, content: safeText(content, ""), ts: nowISO() };
        chat.messages = Array.isArray(chat.messages) ? chat.messages : [];
        chat.messages.push(msg);
        touchChat(chat);
        persistChats();
        return msg;
      }

      function updateLastAssistantMessage(chat, content) {
        if (!chat) return;
        const msgs = chat.messages || [];
        for (let i = msgs.length - 1; i >= 0; i--) {
          if (msgs[i].role === "assistant") {
            msgs[i].content = safeText(content, "");
            msgs[i].ts = nowISO();
            break;
          }
        }
        touchChat(chat);
        persistChats();
      }

      function setStreamingUI(on) {
        state.streaming = !!on;
        el.sendBtn.disabled = state.streaming;
        el.sendBtn.classList.toggle("opacity-60", state.streaming);
        el.sendBtn.classList.toggle("cursor-not-allowed", state.streaming);
        el.stopBtn.classList.toggle("hidden", !state.streaming);
        el.promptInput.disabled = state.streaming;
        el.promptInput.classList.toggle("opacity-60", state.streaming);
      }

      function stopStreaming() {
        try { state.abortController?.abort?.(); } catch (_) {}
        state.abortController = null;
        setStreamingUI(false);
        setStatus("Stopped.", "info");
      }

      async function streamOpenRouter(chat) {
        const key = safeText(state.apiKey, "").trim();
        if (!key) {
          setStatus("Missing API key. Open Settings (‚öô) and paste your OpenRouter key.", "error");
          openModal(el.settingsModal);
          return;
        }

        const model = safeText(state.model, DEFAULT_MODEL).trim() || DEFAULT_MODEL;
        const payload = { model, messages: buildRequestMessages(chat), stream: true, temperature: 0.7 };

        state.abortController = new AbortController();
        setStreamingUI(true);
        setStatus("Streaming...", "info");

        addMessage(chat, "assistant", "");
        renderMessages();

        let fullText = "";
        let lastPaint = 0;

        try {
          const res = await fetch(OPENROUTER_URL, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "Authorization": "Bearer " + key,
              "HTTP-Referer": location.origin || "http://localhost",
              "X-Title": "Universal AI Chat Interface",
            },
            body: JSON.stringify(payload),
            signal: state.abortController.signal
          });

          if (!res.ok || !res.body) {
            const errText = await res.text().catch(() => "");
            throw new Error(`OpenRouter error ${res.status}: ${errText || res.statusText}`);
          }

          const reader = res.body.getReader();
          const decoder = new TextDecoder("utf-8");
          let buffer = "";

          while (true) {
            const { value, done } = await reader.read();
            if (done) break;

            buffer += decoder.decode(value, { stream: true });
            const lines = buffer.split("\n");
            buffer = lines.pop() || "";

            for (const line of lines) {
              const l = line.trim();
              if (!l.startsWith("data:")) continue;
              const data = l.slice(5).trim();
              if (!data) continue;
              if (data === "[DONE]") break;

              let json;
              try { json = JSON.parse(data); } catch (_) { continue; }
              const delta = json?.choices?.[0]?.delta?.content;

              if (typeof delta === "string" && delta.length) {
                fullText += delta;
                const now = Date.now();
                if (now - lastPaint > 30) {
                  updateLastAssistantMessage(chat, fullText);
                  renderMessages();
                  lastPaint = now;
                }
              }
            }
          }

          updateLastAssistantMessage(chat, fullText);
          setChatTitleFromContent(chat);
          persistChats();
          renderChatList();
          renderMessages();
          setStatus("Done.", "info");

          // Auto speak AI response (TTS)
          if (state.autoSpeakAi) speakText(fullText);

        } catch (err) {
          const msg = safeText(err?.message, "Unknown error");
          setStatus(msg, "error");

          if (!fullText) {
            try {
              const msgs = chat.messages || [];
              const last = msgs[msgs.length - 1];
              if (last && last.role === "assistant" && !safeText(last.content).trim()) {
                msgs.pop();
                persistChats();
              }
            } catch (_) {}
          } else {
            updateLastAssistantMessage(chat, fullText + "\n\n*(stream interrupted)*");
            persistChats();
          }
          renderMessages();
        } finally {
          setStreamingUI(false);
          state.abortController = null;
        }
      }

      async function sendMessage() {
        if (state.streaming) return;
        const text = safeText(el.promptInput.value, "").trim();
        if (!text) return;

        const chat = ensureActiveChat();
        addMessage(chat, "user", text);
        setChatTitleFromContent(chat);
        persistChats();

        el.promptInput.value = "";
        autosizeTextarea();
        renderChatList();
        renderMessages();
        scrollToBottom();

        await streamOpenRouter(chat);
      }

      // Advanced agent seed
      const ADV_AGENT_SYSTEM_TEMPLATE = `
You are an advanced, reliable AI agent inside a universal chat UI.

Core behaviors:
- Be proactive: propose a plan and next actions.
- Ask clarifying questions only when needed; otherwise proceed with best assumptions.
- Be concise by default; expand when user asks.
- Use structured output: headings, bullet points, checklists, code blocks.
- Safety: refuse illegal/harmful requests; provide safe alternatives.
- When writing code: include copy-paste-ready snippets and explain critical steps.
- When uncertain: state assumptions and offer verification steps.

If the user asks for "agent mode", respond with:
1) brief plan
2) execution
3) quick checklist of next steps
`.trim();

      function maybeSeedGlobalSystemPrompt() {
        const global = safeText(loadLS(KEYS.globalSystem, ""), "").trim();
        if (!global) setGlobalSystemPrompt(ADV_AGENT_SYSTEM_TEMPLATE);
      }

      // Init
      function init() {
        state.apiKey = safeText(loadLS(KEYS.apiKey, ""), "");
        state.model = safeText(loadLS(KEYS.model, DEFAULT_MODEL), DEFAULT_MODEL) || DEFAULT_MODEL;
        state.dark = loadLS(KEYS.dark, "0") === "1";

        // Audio prefs
        state.voiceLang = safeText(loadLS(KEYS.voiceLang, "bn-BD"), "bn-BD");
        state.autoSendVoice = loadLS(KEYS.autoSendVoice, "0") === "1";
        state.autoSpeakAi = loadLS(KEYS.autoSpeakAi, "0") === "1";

        applyDarkMode(state.dark);
        maybeSeedGlobalSystemPrompt();

        const storedChats = loadJSON(KEYS.chats, []);
        state.chats = Array.isArray(storedChats) ? storedChats : [];

        const active = safeText(loadLS(KEYS.active, ""), "");
        state.activeChatId = active || null;
        ensureActiveChat();

        // Settings UI values
        el.apiKeyInput.value = state.apiKey;
        el.modelInput.value = state.model;

        el.voiceLangSelect.value = state.voiceLang;
        el.autoSendVoiceChk.checked = state.autoSendVoice;
        el.autoSpeakAiChk.checked = state.autoSpeakAi;

        updateHeader();
        renderChatList();
        renderMessages();

        autosizeTextarea();

        // SpeechRecognition init
        state.recognition = initSpeechRecognition();
        setVoiceHint();
        setTtsHint();

        // Loader off after init
        el.loading.style.display = "none";
        el.app.style.display = "flex";

        if (!state.apiKey) setStatus("Add your OpenRouter API key in Settings (‚öô) to start streaming.", "info");
        else setStatus("Ready.", "info");
      }

      // Events
      el.hamburgerBtn.addEventListener("click", openSidebar);
      el.closeSidebarBtn.addEventListener("click", closeSidebar);
      el.mobileOverlay.addEventListener("click", closeSidebar);

      el.newChatBtn.addEventListener("click", newChat);

      el.settingsBtn.addEventListener("click", () => {
        el.apiKeyInput.value = safeText(state.apiKey, "");
        el.modelInput.value = safeText(state.model, DEFAULT_MODEL);

        el.voiceLangSelect.value = state.voiceLang;
        el.autoSendVoiceChk.checked = state.autoSendVoice;
        el.autoSpeakAiChk.checked = state.autoSpeakAi;

        openModal(el.settingsModal);
        setTimeout(() => el.apiKeyInput?.focus(), 0);
      });

      el.saveSettingsBtn.addEventListener("click", () => {
        const k = safeText(el.apiKeyInput.value, "").trim();
        const m = safeText(el.modelInput.value, "").trim() || DEFAULT_MODEL;

        state.apiKey = k;
        state.model = m;

        state.voiceLang = safeText(el.voiceLangSelect.value, "bn-BD");
        state.autoSendVoice = !!el.autoSendVoiceChk.checked;
        state.autoSpeakAi = !!el.autoSpeakAiChk.checked;

        saveLS(KEYS.apiKey, state.apiKey);
        saveLS(KEYS.model, state.model);

        saveLS(KEYS.voiceLang, state.voiceLang);
        saveLS(KEYS.autoSendVoice, state.autoSendVoice ? "1" : "0");
        saveLS(KEYS.autoSpeakAi, state.autoSpeakAi ? "1" : "0");

        // refresh recognition lang
        if (state.recognition) {
          try { state.recognition.lang = state.voiceLang; } catch (_) {}
        } else {
          state.recognition = initSpeechRecognition();
        }

        setVoiceHint();
        setTtsHint();
        updateHeader();

        setStatus("Settings saved.", "info");
        closeModal(el.settingsModal);
      });

      el.darkToggleBtn.addEventListener("click", () => applyDarkMode(!state.dark));

      el.systemPromptBtn.addEventListener("click", openSystemModal);
      el.sysScopeChatBtn.addEventListener("click", () => {
        state.sysScope = "chat";
        highlightSysScopeButtons();
        loadSystemPromptIntoModal("chat");
      });
      el.sysScopeGlobalBtn.addEventListener("click", () => {
        state.sysScope = "global";
        highlightSysScopeButtons();
        loadSystemPromptIntoModal("global");
      });
      el.saveSystemBtn.addEventListener("click", saveSystemPromptFromModal);

      el.clearBtn.addEventListener("click", clearActiveChatMessages);

      el.renameSaveBtn.addEventListener("click", () => {
        const id = state.renameTargetId;
        if (!id) return closeModal(el.renameModal);
        const chat = state.chats.find(c => c.id === id);
        if (chat) {
          const t = safeText(el.renameInput.value, "").trim().slice(0, 80);
          chat.title = t || "Untitled";
          touchChat(chat);
          persistChats();
          renderChatList();
          updateHeader();
        }
        state.renameTargetId = null;
        closeModal(el.renameModal);
      });

      el.chatSearch.addEventListener("input", renderChatList);

      el.promptInput.addEventListener("input", autosizeTextarea);
      el.promptInput.addEventListener("keydown", (e) => {
        if (e.key === "Enter" && !e.shiftKey) {
          e.preventDefault();
          sendMessage();
        }
      });

      el.sendBtn.addEventListener("click", sendMessage);
      el.stopBtn.addEventListener("click", stopStreaming);

      // MIC button
      el.micBtn.addEventListener("click", () => {
        if (state.listening) stopListening();
        else startListening();
      });

      // TTS toggle button
      el.ttsToggleBtn.addEventListener("click", () => {
        state.autoSpeakAi = !state.autoSpeakAi;
        saveLS(KEYS.autoSpeakAi, state.autoSpeakAi ? "1" : "0");
        setTtsHint();
        setStatus("TTS " + (state.autoSpeakAi ? "enabled" : "disabled"), "info");
      });

      window.addEventListener("resize", () => {
        if (window.matchMedia("(min-width: 768px)").matches) {
          el.mobileOverlay.classList.add("hidden");
          el.sidebar.classList.remove("-translate-x-full");
        } else {
          el.sidebar.classList.add("-translate-x-full");
          el.mobileOverlay.classList.add("hidden");
        }
      });

      window.addEventListener("error", (e) => {
        try { setStatus("Runtime error: " + safeText(e?.message, "Unknown"), "error"); } catch (_) {}
      });
      window.addEventListener("unhandledrejection", () => {
        try { setStatus("Unhandled promise rejection.", "error"); } catch (_) {}
      });

      try { init(); } catch (err) {
        try {
          el.loading.innerHTML = `
            <div class="min-h-screen flex items-center justify-center px-6">
              <div class="max-w-lg w-full text-center">
                <div class="text-lg font-semibold text-red-600">App failed to initialize</div>
                <div class="mt-2 text-sm text-zinc-600 dark:text-zinc-300">${safeText(err?.message, "Unknown error")}</div>
              </div>
            </div>`;
        } catch (_) {}
      }
    })();
  </script>
</body>
</html>
